<!DOCTYPE html>
<html>
<head>
    <title>GSV City Explorer</title>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .chart-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            gap: 20px;
        }
        .scatter-plot-container {
            width: 300px;
            height: 300px;
            position: relative;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .legend-color {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
        }
        #stats {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">Loading city data...</div>
    <div id="stats"></div>
    <div class="chart-container">
        <div class="scatter-plot-container">
            <canvas id="panoScatter"></canvas>
        </div>
        <div class="scatter-plot-container">
            <canvas id="areaScatter"></canvas>
        </div>
    </div>
    <div id="legend" class="legend"></div>

    <script>
        // Global variables
        const map = L.map('map').setView([0, 0], 2);
        let charts = { pano: null, area: null };
        let mapRectangles = [];

        // Initialize map
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        function getColor(age) {
            const maxAge = 12;
            const ratio = Math.min(age / maxAge, 1);
            return `rgb(${255}, ${Math.floor(255 * (1 - ratio))}, ${Math.floor(255 * (1 - ratio))})`;
        }

        function createTooltip(city) {
            const cityName = city.city || city.state;
            return `
                <div style="min-width: 250px">
                    <h3>${cityName}, ${city.state}, ${city.country}</h3>
                    <p><strong>Coverage Statistics:</strong></p>
                    <ul style="padding-left: 20px; margin: 5px 0;">
                        <li>Area: ${city.search_area_km2.toFixed(1)} km²</li>
                        <li>Coverage Rate: ${city.coverage_rate_percent.toFixed(1)}%</li>
                        <li>Total Panoramas: ${city.panorama_counts.unique_panos.toLocaleString()}</li>
                        <li>Google Panoramas: ${city.panorama_counts.unique_google_panos.toLocaleString()}</li>
                    </ul>
                    <p><strong>Age Statistics:</strong></p>
                    <ul style="padding-left: 20px; margin: 5px 0;">
                        <li>Median Age: ${city.google_panos_age_stats.median_age_years.toFixed(1)} years</li>
                        <li>Average Age: ${city.google_panos_age_stats.avg_age_years.toFixed(1)} years</li>
                        <li>Newest: ${new Date(city.google_panos_age_stats.newest_date).toLocaleDateString()}</li>
                        <li>Oldest: ${new Date(city.google_panos_age_stats.oldest_date).toLocaleDateString()}</li>
                    </ul>
                </div>
            `;
        }

        function createLegend(maxAge) {
            const legend = document.getElementById('legend');
            const grades = [0, maxAge/4, maxAge/2, 3*maxAge/4, maxAge];
            
            legend.innerHTML = '<h4>Median Age (years)</h4>';
            
            for (let i = 0; i < grades.length - 1; i++) {
                const minAge = grades[i];
                const maxAge = grades[i + 1];
                const color = getColor(minAge);
                
                legend.innerHTML += `
                    <div class="legend-item" data-min-age="${minAge}" data-max-age="${maxAge}">
                        <div class="legend-color" style="background: ${color}"></div>
                        ${minAge.toFixed(1)} &ndash; ${maxAge.toFixed(1)}
                    </div>
                `;
            }

            // Add legend click handlers
            const legendItems = legend.querySelectorAll('.legend-item');
            legendItems.forEach(item => {
                item.addEventListener('click', () => {
                    const minAge = parseFloat(item.dataset.minAge);
                    const maxAge = parseFloat(item.dataset.maxAge);
                    highlightCitiesByAgeRange(minAge, maxAge);
                });
            });
        }

        function highlightCitiesByAgeRange(minAge, maxAge) {
            [charts.pano, charts.area].forEach(chart => {
                chart.data.datasets[0].pointBackgroundColor = chart.data.datasets[0].data.map(point => {
                    const age = point.y;
                    return (age >= minAge && age < maxAge) ? point.backgroundColor : 'rgba(200,200,200,0.2)';
                });
                chart.update();
            });

            mapRectangles.forEach(rectangle => {
                const age = rectangle.city.google_panos_age_stats.median_age_years;
                if (age >= minAge && age < maxAge) {
                    rectangle.setStyle({
                        fillOpacity: 0.8,
                        weight: 2
                    });
                } else {
                    rectangle.setStyle({
                        fillOpacity: 0.2,
                        weight: 1
                    });
                }
            });
        }

        function highlightCity(city) {
            [charts.pano, charts.area].forEach(chart => {
                chart.data.datasets[0].pointBackgroundColor = chart.data.datasets[0].data.map(point => 
                    point.city === city ? point.backgroundColor : 'rgba(200,200,200,0.2)'
                );
                chart.update();
            });

            mapRectangles.forEach(rectangle => {
                if (rectangle.city === city) {
                    rectangle.setStyle({
                        fillOpacity: 0.8,
                        weight: 2
                    });
                } else {
                    rectangle.setStyle({
                        fillOpacity: 0.2,
                        weight: 1
                    });
                }
            });
        }

        function resetHighlights() {
            [charts.pano, charts.area].forEach(chart => {
                chart.data.datasets[0].pointBackgroundColor = chart.data.datasets[0].data.map(point => 
                    point.backgroundColor
                );
                chart.update();
            });

            mapRectangles.forEach(rectangle => {
                rectangle.setStyle({
                    fillOpacity: 0.6,
                    weight: 1
                });
            });
        }

        function createScatterPlots(cities) {
            // Create data for plots
            const panoData = cities.map(city => ({
                x: city.panorama_counts.unique_google_panos,
                y: city.google_panos_age_stats.median_age_years,
                city: city,
                backgroundColor: getColor(city.google_panos_age_stats.median_age_years)
            }));

            const areaData = cities.map(city => ({
                x: city.search_area_km2,
                y: city.google_panos_age_stats.median_age_years,
                city: city,
                backgroundColor: getColor(city.google_panos_age_stats.median_age_years)
            }));

            // Shared chart options
            const sharedOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const city = context.raw.city;
                                const cityName = city.city || city.state;
                                return [
                                    `${cityName}, ${city.state}`,
                                    `Age: ${context.raw.y.toFixed(1)} years`,
                                    `Coverage: ${city.coverage_rate_percent.toFixed(1)}%`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Median Age (years)'
                        }
                    }
                },
                onHover: (event, elements) => {
                    if (elements.length > 0) {
                        highlightCity(elements[0].element.$context.raw.city);
                    } else {
                        resetHighlights();
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const city = elements[0].element.$context.raw.city;
                        const bounds = [
                            [city.bounds.min_lat, city.bounds.min_lon],
                            [city.bounds.max_lat, city.bounds.max_lon]
                        ];
                        const latSpan = city.bounds.max_lat - city.bounds.min_lat;
                        const lonSpan = city.bounds.max_lon - city.bounds.min_lon;
                        const padding = Math.max(latSpan, lonSpan) * 0.2;
                        const paddedBounds = [
                            [bounds[0][0] - padding, bounds[0][1] - padding],
                            [bounds[1][0] + padding, bounds[1][1] + padding]
                        ];
                        map.fitBounds(paddedBounds);
                    }
                }
            };

            // Create pano scatter plot
            charts.pano = new Chart(document.getElementById('panoScatter'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: panoData,
                        backgroundColor: panoData.map(d => d.backgroundColor),
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        borderColor: 'rgba(0,0,0,0.2)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...sharedOptions,
                    plugins: {
                        ...sharedOptions.plugins,
                        title: {
                            display: true,
                            text: 'Pano Count vs Median Age'
                        }
                    },
                    scales: {
                        ...sharedOptions.scales,
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Total Panos (log scale)'
                            },
                            min: 100
                        }
                    }
                }
            });

            // Create area scatter plot
            charts.area = new Chart(document.getElementById('areaScatter'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: areaData,
                        backgroundColor: areaData.map(d => d.backgroundColor),
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        borderColor: 'rgba(0,0,0,0.2)',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...sharedOptions,
                    plugins: {
                        ...sharedOptions.plugins,
                        title: {
                            display: true,
                            text: 'Area vs Median Age'
                        }
                    },
                    scales: {
                        ...sharedOptions.scales,
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Area (km², log scale)'
                            },
                            min: 1
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                const rawUrl = 'https://raw.githubusercontent.com/jonfroehlich/gsv-tracker/main/data/cities.json.gz';
                const response = await fetch(rawUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const compressed = await response.arrayBuffer();
                const decompressed = pako.inflate(new Uint8Array(compressed), { to: 'string' });
                const data = JSON.parse(decompressed);
                const cities = data.cities;

                // Update stats overlay
                document.getElementById('stats').innerHTML = `
                    <strong>GSV City Coverage Analysis</strong><br>
                    ${data.cities_count} cities analyzed | Updated: ${new Date(data.creation_timestamp).toLocaleString()}
                `;

                // Hide loading message
                document.getElementById('loading').style.display = 'none';

                // Calculate max age for legend
                const maxAge = Math.max(...cities.map(city => city.google_panos_age_stats.median_age_years));
                createLegend(maxAge);

                // Add rectangles to map
                cities.forEach(city => {
                    const bounds = [
                        [city.bounds.min_lat, city.bounds.min_lon],
                        [city.bounds.max_lat, city.bounds.max_lon]
                    ];

                    const rectangle = L.rectangle(bounds, {
                        color: getColor(city.google_panos_age_stats.median_age_years),
                        weight: 1,
                        fillOpacity: 0.6
                    }).addTo(map);

                    // Store reference to city data in rectangle
                    rectangle.city = city;
                    rectangle.bindPopup(createTooltip(city));
                    mapRectangles.push(rectangle);

                    // Add hover effects
                    rectangle.on('mouseover', function (e) {
                        highlightCity(city);
                    });

                    rectangle.on('mouseout', function (e) {
                        resetHighlights();
                    });
                });

                // Create scatter plots
                createScatterPlots(cities);

                // Fit map to show all cities
                const allBounds = cities.map(city => [
                    [city.bounds.min_lat, city.bounds.min_lon],
                    [city.bounds.max_lat, city.bounds.max_lon]
                ]);
                map.fitBounds(allBounds);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 'Error loading city data. Please check the console for details.';
            }
        }

        // Start loading data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>